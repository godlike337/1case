<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Olympics</title>

    <!-- Стили -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="/static/css/style.css">
    <link rel="icon" href="static/favicon.ico">
    <!-- Библиотеки -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- MathJax для формул (опционально, если нужно рендерить LaTeX) -->
    <script>
        window.MathJax = { tex: { inlineMath: [['$', '$'], ['\\(', '\\)']] } };
    </script>
    <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js" async></script>
</head>
<body>

<div id="app" v-cloak :class="['app-container', state]">

    <!-- ================= АВТОРИЗАЦИЯ ================= -->
    <div v-if="state === 'login' || state === 'register' || state === 'forgot'" class="screen-auth">
        <div class="auth-card">
            <h1 class="auth-title">OLIMP<span class="accent">ICS</span></h1>

            <!-- Вход -->
            <form v-if="state === 'login'" @submit.prevent="login">
                <div class="input-group">
                    <i class="fa-solid fa-user"></i>
                    <input type="text" v-model="authForm.username" placeholder="Логин" required>
                </div>
                <div class="input-group">
                    <i class="fa-solid fa-lock"></i>
                    <input type="password" v-model="authForm.password" placeholder="Пароль" required>
                </div>
                <button type="submit" class="cyber-btn full">ВОЙТИ</button>
                <div class="auth-links">
                    <a href="#" @click.prevent="goTo('register')">Регистрация</a>
                    <a href="#" @click.prevent="goTo('forgot')">Забыли пароль?</a>
                </div>
            </form>

            <!-- Регистрация -->
            <form v-if="state === 'register'" @submit.prevent="register">
                <div class="input-group">
                    <i class="fa-solid fa-user"></i>
                    <input type="text" v-model="authForm.username" placeholder="Логин" required>
                </div>
                <div class="input-group">
                    <i class="fa-solid fa-envelope"></i>
                    <input type="email" v-model="authForm.email" placeholder="Email" required>
                </div>
                <div class="input-group">
                    <i class="fa-solid fa-graduation-cap"></i>
                    <select v-model.number="authForm.grade" required>
                        <option disabled value="">Выберите класс</option>
                        <option v-for="g in 11" :key="g" :value="g">{{ g }} класс</option>
                    </select>
                </div>
                <div class="input-group">
                    <i class="fa-solid fa-lock"></i>
                    <input type="password" v-model="authForm.password" placeholder="Пароль" required>
                </div>
                <button type="submit" class="cyber-btn full">СОЗДАТЬ АККАУНТ</button>
                <div class="auth-links">
                    <a href="#" @click.prevent="goTo('login')">Назад ко входу</a>
                </div>
            </form>

            <!-- Сброс пароля -->
            <div v-if="state === 'forgot'" class="forgot-block">
                <p>Для сброса пароля обратитесь в поддержку:</p>
                <a href="https://t.me/whosgodlike" target="_blank" class="cyber-btn tg-btn">
                    <i class="fa-brands fa-telegram"></i> Написать в Support
                </a>
                <div class="auth-links">
                    <a href="#" @click.prevent="goTo('login')">Назад</a>
                </div>
            </div>
        </div>
    </div>

    <!-- ================= ОСНОВНОЙ ИНТЕРФЕЙС ================= -->
    <div v-else class="main-layout">

        <!-- Верхняя шапка -->
        <header class="top-bar">
            <div class="user-info">
                <span class="username">{{ userStats.username }}</span>
                <span class="badge level">Lvl {{ userStats.level }}</span>
                <span class="badge rating"><i class="fa-solid fa-trophy"></i> {{ userStats.rating }}</span>
            </div>
            <button class="cyber-btn sm" @click="goTo('profile')">
                <i class="fa-solid fa-user-astronaut"></i> ПРОФИЛЬ
            </button>
        </header>

        <!-- Контент -->
        <main class="content-area">

            <!-- МЕНЮ -->
            <div v-if="state === 'menu'" class="screen-menu">
                <div class="logo-container">
                    <img src="static/src/logo.png" alt="Project Logo" class="main-logo">
                </div>
                <div class="menu-buttons">
                    <button class="cyber-btn lg" @click="goTo('topic_select')">
                        <i class="fa-solid fa-brain"></i> ТРЕНИРОВКА
                    </button>
                    <button class="cyber-btn lg red-glow" @click="goTo('pvp_setup')">
                        <i class="fa-solid fa-khanda"></i> PvP БИТВА
                    </button>
                </div>
            </div>

            <!-- ПРОФИЛЬ -->
            <div v-if="state === 'profile'" class="screen-profile">
                <div class="profile-header">
                    <button class="back-btn" @click="goTo('menu')"><i class="fa-solid fa-arrow-left"></i> Назад</button>
                    <h2>Профиль</h2>
                </div>

                <div class="profile-grid">
                    <!-- Левая колонка: Статы -->
                    <div class="profile-card stats-card">
                        <div class="avatar-ph">
                            <i class="fa-solid fa-user-circle"></i>
                        </div>
                        <h3>{{ userStats.username }}</h3>
                        <div class="xp-container">
                            <div class="xp-info">
                                <span>Lvl {{ userStats.level }}</span>
                                <span>{{ userStats.xp }} XP</span>
                            </div>
                            <div class="xp-bar-bg"><div class="xp-bar-fill" :style="{width: (userStats.xp % 100) + '%'}"></div></div>
                        </div>
                        <div class="mini-stats">
                            <div><span>Побед </span><strong>{{ userStats.wins }}</strong></div>
                            <div><span>Матчей </span><strong>{{ userStats.matches_played || 0 }}</strong></div>
                        </div>
                        <button class="cyber-btn sm logout" @click="logout">ВЫЙТИ</button>
                    </div>

                    <!-- Правая колонка: Аналитика и История -->
                    <div class="profile-content">
                        <div class="tabs">
                            <button :class="['tab-btn', {active: profileTab==='analytics'}]" @click="profileTab='analytics'">Аналитика</button>
                            <button :class="['tab-btn', {active: profileTab==='history'}]" @click="profileTab='history'">История матчей</button>
                        </div>

                        <div v-show="profileTab==='analytics'" class="analytics-view">
                            <div class="charts-row">
                                <div class="chart-box">
                                    <canvas id="winRateChart"></canvas>
                                </div>
                                <div class="stats-text-box">
                                    <p>Винрейт: <strong>{{ analyticsData?.win_rate?.toFixed(1) || 0 }}%</strong></p>
                                    <p>Точность ответов: <strong>{{ analyticsData?.correct_answers?.toFixed(1) || 0 }}%</strong></p>
                                    <p>Ср. время решения: <strong>{{ analyticsData?.avg_solving_time || 0 }} сек</strong></p>
                                </div>
                            </div>
                            <div class="chart-box full-width">
                                <h4>Темы тренировок</h4>
                                <canvas id="topicsChart"></canvas>
                            </div>
                        </div>

                        <div v-show="profileTab==='history'" class="history-view">
                            <div class="history-list">
                                <div v-for="match in paginatedHistory" :key="match.id" class="match-item">
                                    <div class="match-date">{{ formatDate(match.played_at) }}</div>
                                    <div class="match-vs">
                                        <span :class="{winner: getMyResult(match) === 'win'}">{{ match.player1 ? match.player1.username : '???' }}</span>
                                        <span class="vs-badge">VS</span>
                                        <span :class="{winner: getMyResult(match) === 'lose'}">{{ match.player2 ? match.player2.username : '???' }}</span>
                                    </div>
                                    <div class="match-score">{{ match.p1_score }} : {{ match.p2_score }}</div>
                                    <div :class="['match-result', getMyResult(match)]">{{ getResultText(match) }}</div>
                                </div>
                                <div v-if="history.length === 0" class="no-data">История пуста</div>
                            </div>
                            <div class="pagination">
                                <button @click="historyPage--" :disabled="historyPage === 0"><i class="fa-solid fa-chevron-left"></i></button>
                                <span>{{ historyPage + 1 }}</span>
                                <button @click="historyPage++" :disabled="(historyPage + 1) * 5 >= history.length"><i class="fa-solid fa-chevron-right"></i></button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ТРЕНИРОВКА: Выбор темы -->
            <div v-if="state === 'topic_select'" class="screen-setup">
                <button class="back-btn" @click="goTo('menu')"><i class="fa-solid fa-arrow-left"></i></button>
                <h2>НАСТРОЙКА ТРЕНИРОВКИ</h2>

                <div class="setup-group">
                    <label>Предмет:</label>
                    <div class="subject-toggles">
                        <button :class="{active: subject==='python'}" @click="subject='python'">Python</button>
                        <button :class="{active: subject==='math'}" @click="subject='math'">Математика</button>
                    </div>
                </div>

                <div class="setup-group">
                    <label>Сложность:</label>
                    <input type="range" min="1" max="5" v-model.number="selectedDifficulty" class="cyber-range">
                    <div class="range-val">{{ selectedDifficulty }}/5</div>
                </div>

                <div class="topics-grid">
                    <button v-for="t in currentTopics" :key="t.id" class="topic-card" @click="selectTopic(t.id)">
                        {{ t.name }}
                    </button>
                </div>
            </div>

            <!-- ТРЕНИРОВКА / PVP: Решение задачи -->
            <div v-if="state === 'training_solve' || state === 'playing'" class="screen-game">
                <div class="game-header">
                    <button v-if="state === 'training_solve'" class="back-btn" @click="goTo('topic_select')">Выход</button>
                    <div v-if="state === 'playing'" class="pvp-score-board">
                        <div class="p-score me">{{ myScore }}</div>
                        <div class="timer" :class="{danger: timeLeft < 10}">{{ timeLeft }}</div>
                        <div class="p-score enemy">{{ enemyScore }}</div>
                    </div>
                </div>

                <div class="task-card">
                    <div class="task-meta">
                        <span class="difficulty">Сложность: {{ activeTask?.difficulty || task?.difficulty }}</span>
                        <span class="task-type">{{ (activeTask?.task_type || task?.task_type) === 'choice' ? 'Тест' : 'Ввод' }}</span>
                    </div>
                    <h3>{{ activeTask?.title || task?.title }}</h3>
                    <p class="task-desc" v-html="renderMath(activeTask?.description || task?.description)"></p>

                    <!-- Варианты ответа -->
                    <div v-if="(activeTask?.task_type || task?.task_type) === 'choice'" class="options-grid">
                        <button v-for="opt in (activeTask?.options || task?.options)"
                                :key="opt"
                                class="option-btn"
                                @click="handleAnswer(opt)">
                            {{ opt }}
                        </button>
                    </div>

                    <!-- Текстовый ввод -->
                    <div v-else class="text-answer-box">
                        <input type="text"
                               v-model="currentAnswerInput"
                               placeholder="Ваш ответ..."
                               @keyup.enter="handleAnswer(currentAnswerInput)"
                               :disabled="solveResult !== null || answerSent">
                        <button class="cyber-btn" @click="handleAnswer(currentAnswerInput)">ОТПРАВИТЬ</button>
                    </div>

                    <!-- Результат (Тренировка) -->
                    <div v-if="solveResult" :class="['result-msg', solveResult]">
                        {{ solveResult === 'correct' ? 'ВЕРНО!' : 'НЕВЕРНО' }}
                        <button v-if="solveResult === 'correct'" @click="goTo('topic_select')" class="next-btn">Далее</button>
                    </div>

                    <!-- Результат раунда (PVP) -->
                    <div v-if="roundFinished" class="round-overlay">
                        <div class="round-modal">
                            <h3>Раунд завершен</h3>
                            <div class="round-res-grid">
                                <div :class="roundResult.you">ВЫ</div>
                                <div :class="roundResult.enemy">СОПЕРНИК</div>
                            </div>
                            <p>Правильный ответ: {{ roundResult.correct }}</p>
                            <p>Следующий раунд через: {{ nextRoundTimer.toFixed(1) }}</p>
                        </div>
                    </div>

                    <!-- Подсказки (только тренировка) -->
                    <div v-if="state === 'training_solve'" class="hints-section">
                        <div v-for="(h, idx) in revealedHints" :key="idx" class="hint-bubble">{{ h }}</div>
                        <button v-if="revealedHints.length < (activeTask?.hints_available || 0)"
                                @click="useHint"
                                class="hint-btn">
                            <i class="fa-regular fa-lightbulb"></i> Взять подсказку
                        </button>
                    </div>
                </div>
            </div>

            <!-- PVP: Поиск -->
            <div v-if="state === 'searching'" class="screen-centered">
                <div class="loader-ring"></div>
                <h2>Поиск соперника...</h2>
                <button class="cyber-btn outline" @click="reset">ОТМЕНА</button>
            </div>

             <!-- PVP: VS Экран -->
             <div v-if="state === 'vs'" class="screen-vs">
                <div class="vs-player me">
                    <div class="av">ME</div>
                    <h3>{{ userStats.username }}</h3>
                    <p>{{ userStats.rating }} MMR</p>
                </div>
                <div class="vs-center">
                    <h1>VS</h1>
                    <div class="countdown">{{ vsTimer }}</div>
                </div>
                <div class="vs-player enemy">
                    <div class="av">OP</div>
                    <h3>{{ opponentName }}</h3>
                    <p>{{ opponentRating }} MMR</p>
                </div>
            </div>

            <!-- PVP: Финал -->
            <div v-if="state === 'finished'" class="screen-centered">
                <h1 :class="finalData.result === 'win' ? 'text-win' : 'text-lose'">
                    {{ finalData.result === 'win' ? 'ПОБЕДА' : finalData.result === 'draw' ? 'НИЧЬЯ' : 'ПОРАЖЕНИЕ' }}
                </h1>
                <div class="final-score">
                    {{ finalData.my_score }} : {{ finalData.enemy_score }}
                </div>
                <p>Новый рейтинг: {{ finalData.new_rating }}</p>
                <button class="cyber-btn lg" @click="goTo('menu')">В МЕНЮ</button>
            </div>

            <!-- Загрузка AI -->
            <div v-if="state === 'loading_ai'" class="screen-centered">
                <div class="ai-loader">
                    <span></span><span></span><span></span>
                </div>
                <h3>Нейросеть генерирует задачу...</h3>
            </div>

        </main>

        <!-- Нижняя шапка -->
        <footer class="bottom-bar">
            <a href="https://t.me/whosgodlike" target="_blank" class="support-link">
                <i class="fa-regular fa-life-ring"></i> Поддержка
            </a>
            <span class="copyright">© 2026 OlimpicOS System</span>
        </footer>
    </div>
</div>

<script type="module" src="/static/js/app.js"></script>
</body>
</html>