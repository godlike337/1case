<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Olympus Platform</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º –Ω–∞—à CSS -->
    <link rel="stylesheet" href="/static/css/style.css">
</head>
<body>

<!-- –ê—Ç—Ä–∏–±—É—Ç v-cloak –Ω—É–∂–µ–Ω, —á—Ç–æ–±—ã —Å–∫—Ä—ã—Ç—å {{ }} –¥–æ –∑–∞–≥—Ä—É–∑–∫–∏ JS -->
<div id="app" class="app" v-cloak>

    <!-- 1. –ê–í–¢–û–†–ò–ó–ê–¶–ò–Ø -->
    <div v-if="!token">
        <h1 style="text-align: center; margin-bottom: 20px;">üöÄ OLYMPUS</h1>
        <div class="card">
            <h3 style="margin-top: 0;">–í—Ö–æ–¥</h3>
            <input v-model="authForm.username" placeholder="–õ–æ–≥–∏–Ω">
            <input v-model="authForm.email" placeholder="Email (–¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏)">
            <input v-model="authForm.password" type="password" placeholder="–ü–∞—Ä–æ–ª—å" @keyup.enter="login">
            <button @click="login">–í–æ–π—Ç–∏</button>
            <button class="btn-secondary" @click="register">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
        </div>
    </div>

    <!-- 2. –ú–ï–ù–Æ -->
    <div v-else-if="state === 'menu'">
        <div class="header-bar">
            <span style="font-size: 18px;">üë§ {{ userStats.username }}</span>
            <button class="btn-secondary btn-small" @click="logout">–í—ã–π—Ç–∏</button>
        </div>

        <div class="card">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <h3 style="margin: 0;">–£—Ä–æ–≤–µ–Ω—å {{ userStats.level || 1 }}</h3>
                <span style="color: #00b894; font-weight: bold;">{{ userStats.rating || 1000 }} MMR</span>
            </div>

            <div class="xp-bar">
                <div class="xp-fill" :style="{width: (userStats.xp % 100) + '%'}"></div>
            </div>
            <div style="font-size: 12px; color: #888; margin-bottom: 15px;">XP: {{ userStats.xp || 0 }} / 100</div>

            <div class="achievement-row" v-if="userStats.achievements && userStats.achievements.length">
                <div v-for="ach in userStats.achievements" :key="ach.name" class="ach-badge" :title="ach.name + ': ' + ach.description">
                    {{ ach.icon }}
                </div>
            </div>
            <div v-else style="font-size: 12px; color: #666; font-style: italic;">–ù–µ—Ç –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π... –ø–æ–∫–∞ —á—Ç–æ.</div>

            <div style="margin-top: 15px; display: flex; gap: 10px;">
                <div style="text-align: center; flex: 1;">
                    <div style="font-weight: bold; font-size: 18px;">{{ userStats.wins }}</div>
                    <div style="font-size: 10px; color: #888;">–ü–û–ë–ï–î</div>
                </div>
                <div style="text-align: center; flex: 1;">
                    <div style="font-weight: bold; font-size: 18px;">{{ userStats.matches_played }}</div>
                    <div style="font-size: 10px; color: #888;">–ò–ì–†</div>
                </div>
            </div>
            <button class="btn-secondary" style="margin-top: 15px; font-size: 12px;" @click="openHistory">üìú –ò—Å—Ç–æ—Ä–∏—è –º–∞—Ç—á–µ–π</button>
        </div>

        <div class="card" style="border-color: #6c5ce7;">
            <h3 style="color: #a29bfe;">‚öîÔ∏è –í –±–æ–π</h3>
            <label style="font-size: 12px; color: #888; font-weight: bold;">–í–´–ë–ï–†–ò –ü–†–ï–î–ú–ï–¢</label>
            <select v-model="subject">
                <option value="python">üêç Python</option>
                <option value="math">üìê –ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞</option>
            </select>

            <button @click="startSearch">‚öîÔ∏è PvP –ë–∏—Ç–≤–∞</button>
            <button class="btn-secondary" @click="openTraining">üéì –¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞</button>
        </div>
    </div>

    <!-- 3. –ü–û–ò–°–ö PVP -->
    <div v-else-if="state === 'searching'" style="text-align: center; margin-top: 80px;">
        <div class="searching-anim">üì°</div>
        <h2>–ü–æ–∏—Å–∫ —Å–æ–ø–µ—Ä–Ω–∏–∫–∞...</h2>
        <p style="color: #888;">{{ subject }}</p>
        <button class="btn-secondary" style="width: 200px;" @click="reset">–û—Ç–º–µ–Ω–∞</button>
    </div>

    <!-- 4. PVP –ò–ì–†–ê -->
    <div v-else-if="state === 'playing'">
        <div class="header-bar">
            <div class="score-box" :style="{borderColor: myScore > enemyScore ? '#00b894' : '#444'}">–í—ã: {{ myScore }}</div>
            <div style="color: #888; font-size: 12px;">–†–ê–£–ù–î {{ currentRound }}/{{ totalRounds }}</div>
            <div class="score-box" :style="{borderColor: enemyScore > myScore ? '#d63031' : '#444'}">–í—Ä–∞–≥: {{ enemyScore }}</div>
        </div>
        <div class="timer-big" :style="{color: timeLeft < 5 ? '#ff7675' : '#fdcb6e'}">{{ timeLeft }}</div>
        <div class="card">
            <h3 style="margin: 0 0 10px 0;">{{ task.title }}</h3>
            <p style="line-height: 1.6; color: #b2bec3;">{{ task.desc }}</p>
        </div>
        <div v-if="!roundFinished">
            <input id="pvpInput" v-model="answer" placeholder="–û—Ç–≤–µ—Ç..." autocomplete="off" @keyup.enter="sendPvPAnswer" :disabled="answerSent">
            <button @click="sendPvPAnswer" :disabled="answerSent" :style="{background: answerSent ? '#2d3436' : ''}">{{ answerSent ? '‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ...' : '–û–¢–í–ï–¢–ò–¢–¨' }}</button>
        </div>
        <div v-else class="card" style="text-align: center;">
            <h2 v-if="roundResult.you === 'correct'" class="win-text">‚úÖ –í–µ—Ä–Ω–æ!</h2>
            <h2 v-else class="lose-text">‚ùå –û—à–∏–±–∫–∞ ({{ roundResult.correct }})</h2>
            <div style="margin-top: 10px; font-size: 12px; color: #888;">–°–ª–µ–¥—É—é—â–∏–π —Ä–∞—É–Ω–¥ —á–µ—Ä–µ–∑ {{ nextRoundTimer.toFixed(1) }}—Å</div>
        </div>
    </div>

    <!-- 5. PVP –§–ò–ù–ê–õ -->
    <div v-else-if="state === 'finished'" style="text-align: center; padding-top: 50px;">
        <h1 v-if="finalData.result === 'win'" class="win-text">üèÜ –ü–û–ë–ï–î–ê!</h1>
        <h1 v-else-if="finalData.result === 'lose'" class="lose-text">üíÄ –ü–û–†–ê–ñ–ï–ù–ò–ï</h1>
        <h1 v-else class="draw-text">ü§ù –ù–ò–ß–¨–Ø</h1>
        <h2>{{ myScore }} : {{ enemyScore }}</h2>
        <p v-if="finalData.new_rating" style="color: #fdcb6e;">–í–∞—à —Ä–µ–π—Ç–∏–Ω–≥: {{ finalData.new_rating }}</p>
        <button @click="reset">–í –ú–ï–ù–Æ</button>
    </div>

<!-- 6. –¢–†–ï–ù–ò–†–û–í–ö–ê –°–ü–ò–°–û–ö -->
    <div v-else-if="state === 'training_list'">
        <div class="header-bar">
            <h2>–ö–∞—Ç–∞–ª–æ–≥</h2>
            <button class="btn-secondary btn-small" @click="state = 'menu'">–ù–∞–∑–∞–¥</button>
        </div>

        <div v-if="trainingTasks.length === 0" style="text-align: center; color: #666; margin-top: 30px;">
            –ù–µ—Ç –∑–∞–¥–∞—á –ø–æ —ç—Ç–æ–º—É –ø—Ä–µ–¥–º–µ—Ç—É.
        </div>

        <div v-for="t in trainingTasks" :key="t.id" class="task-list-item" @click="openTask(t)">
            <div>
                <div style="font-weight: bold; display: flex; align-items: center;">
                    {{ t.title }}
                    <!-- –ì–∞–ª–æ—á–∫–∞ (–∑–∞—â–∏—Ç–∞ –æ—Ç –¥—é–ø–∞) -->
                    <span v-if="t.is_solved" class="solved-badge" style="margin-left: 10px; font-size: 12px; color: #00b894;">
                        ‚úÖ
                    </span>
                </div>
                <div style="font-size: 12px; color: #888; margin-top: 4px;">
                    –°–ª–æ–∂–Ω–æ—Å—Ç—å: {{ t.difficulty }}
                </div>
            </div>
            <span style="color: #666;">‚ûú</span>
        </div>
    </div>

    <!-- 7. –¢–†–ï–ù–ò–†–û–í–ö–ê –†–ï–®–ï–ù–ò–ï -->
    <div v-else-if="state === 'training_solve'">
        <div class="card">
            <span style="font-size: 12px; color: #a29bfe; font-weight: bold;">–¢–†–ï–ù–ò–†–û–í–ö–ê</span>
            <h2>{{ activeTask.title }}</h2>
            <p style="color: #ccc;">{{ activeTask.description }}</p>
        </div>
        <div class="card">
            <input v-model="trainingAnswer" placeholder="–í–∞—à –æ—Ç–≤–µ—Ç..." @keyup.enter="checkTrainingAnswer">
            <button @click="checkTrainingAnswer">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å</button>
            <div v-if="solveResult" style="margin-top: 10px; font-weight: bold;" :class="solveResult === 'correct' ? 'win-text' : 'lose-text'">
                {{ solveResult === 'correct' ? '‚úÖ –í–µ—Ä–Ω–æ! +XP' : '‚ùå –ù–µ–≤–µ—Ä–Ω–æ' }}
            </div>
        </div>
        <button class="btn-secondary" @click="openTraining">–ö —Å–ø–∏—Å–∫—É</button>
    </div>

    <!-- 8. –ò–°–¢–û–†–ò–Ø -->
    <div v-if="showHistory" class="history-modal">
        <div style="max-width: 500px; margin: 0 auto;">
            <div class="header-bar">
                <h2 style="margin: 0;">–ò—Å—Ç–æ—Ä–∏—è</h2>
                <button class="btn-secondary btn-small" @click="showHistory = false">X</button>
            </div>
            <div v-for="match in historyList" :key="match.id" class="history-item" :class="getMatchClass(match)">
                <div>
                    <div style="font-weight: bold;">{{ match.subject.toUpperCase() }}</div>
                    <div style="font-size: 12px; color: #888;">{{ new Date(match.played_at).toLocaleDateString() }}</div>
                </div>
                <div style="text-align: right;">
                    <div style="font-weight: bold;">{{ getScoreText(match) }}</div>
                    <div style="font-size: 12px;">{{ getResultText(match) }}</div>
                </div>
            </div>
        </div>
    </div>

</div>

<!-- –ü–û–î–ö–õ–Æ–ß–ê–ï–ú –°–ö–†–ò–ü–¢ –ú–û–î–£–õ–ï–ú -->
<script type="module" src="/static/js/app.js"></script>

</body>
</html>