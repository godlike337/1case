<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Olympus AI Platform</title>

    <!-- –®—Ä–∏—Ñ—Ç—ã –∏ –ò–∫–æ–Ω–∫–∏ -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- KaTeX (–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>

    <!-- –¢–≤–æ–π CSS -->
    <link rel="stylesheet" href="/static/css/style.css">
</head>
<body>

<div id="app" class="app" v-cloak>

    <!-- ========================================== -->
    <!-- 1. –ê–í–¢–û–†–ò–ó–ê–¶–ò–Ø                             -->
    <!-- ========================================== -->
    <div v-if="!token">
        <h1 class="logo-text" style="text-align: center; font-size: 32px; margin-bottom: 20px;">üöÄ OLYMPUS AI</h1>
        <div class="card">
            <h3 style="margin-top: 0;">–í—Ö–æ–¥ / –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h3>
            <input v-model="authForm.username" placeholder="–õ–æ–≥–∏–Ω">
            <input v-model="authForm.email" placeholder="Email">
            <input v-model="authForm.password" type="password" placeholder="–ü–∞—Ä–æ–ª—å">

            <div style="margin: 10px 0;">
                <label style="font-size: 12px; color: #888;">–í–∞—à –∫–ª–∞—Å—Å (1-11):</label>
                <select v-model.number="authForm.grade" style="width: 100%; padding: 10px; background: #2b2b36; color: white; border: 1px solid #444; border-radius: 8px;">
                    <option v-for="n in 11" :value="n" :key="n">{{ n }} –∫–ª–∞—Å—Å</option>
                </select>
            </div>

            <button @click="login">–í–æ–π—Ç–∏</button>
            <button class="btn-secondary" @click="register">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
        </div>
    </div>

    <!-- ========================================== -->
    <!-- 2. –ì–õ–ê–í–ù–û–ï –ú–ï–ù–Æ                            -->
    <!-- ========================================== -->
    <div v-else-if="state === 'menu'">
        <div class="header-bar">
            <span>üë§ {{ userStats.username }} <small>({{ userStats.grade }} –∫–ª)</small></span>
            <button class="btn-secondary btn-small" @click="logout">–í—ã–π—Ç–∏</button>
        </div>

        <!-- –ü–†–û–§–ò–õ–¨ -->
        <div class="card profile-card">
            <div style="display: flex; justify-content: space-between;">
                <span class="level-badge" style="background: #fdcb6e; color: #222; padding: 4px 8px; border-radius: 6px; font-weight: bold;">
                    {{ userStats.level }} Lvl
                </span>
                <span class="xp-text" style="color: #888; font-size: 12px;">XP: {{ userStats.xp }}/100</span>
            </div>
            <div class="xp-bar" style="height: 8px; background: #333; margin: 10px 0; border-radius: 4px; overflow: hidden;">
                <div class="xp-fill" :style="{width: (userStats.xp % 100) + '%', background: '#00b894', height: '100%'}"></div>
            </div>

            <div class="stats-grid" style="display: flex; gap: 10px; margin-top: 15px;">
                <div style="flex: 1; text-align: center; background: #2b2b36; padding: 10px; border-radius: 8px;">
                    <div style="font-size: 20px; font-weight: bold; color: #00b894;">{{ userStats.rating }}</div>
                    <div style="font-size: 10px; color: #888;">MMR</div>
                </div>
                <div style="flex: 1; text-align: center; background: #2b2b36; padding: 10px; border-radius: 8px;">
                    <div style="font-size: 20px; font-weight: bold;">{{ userStats.wins }}</div>
                    <div style="font-size: 10px; color: #888;">–ü–û–ë–ï–î</div>
                </div>
            </div>

            <button class="btn-secondary" style="margin-top: 15px; font-size: 12px;" @click="loadHistory">üìú –ò—Å—Ç–æ—Ä–∏—è</button>
            <button class="btn-secondary" style="margin-top: 15px; font-size: 12px;" @click="loadAnalytics">üìä –ê–Ω–∞–ª–∏—Ç–∏–∫–∞</button>
        </div>

        <!-- –î–ï–ô–°–¢–í–ò–Ø -->
        <div class="card action-card" style="border-color: #6c5ce7;">
            <h3 style="color: #a29bfe; margin-top: 0;">üéØ –†–µ–∂–∏–º—ã</h3>
            <div class="subject-select" style="display: flex; gap: 10px; margin-bottom: 20px;">
                <label style="flex: 1; cursor: pointer;">
                    <input type="radio" value="python" v-model="subject" style="display:none;">
                    <span :style="subject==='python' ? 'background: #6c5ce7; border-color: #6c5ce7;' : 'background: #2b2b36;'"
                          style="display: block; text-align: center; padding: 12px; border-radius: 8px; border: 1px solid #444; transition: 0.2s;">
                        üêç Python
                    </span>
                </label>
                <label style="flex: 1; cursor: pointer;">
                    <input type="radio" value="math" v-model="subject" style="display:none;">
                    <span :style="subject==='math' ? 'background: #6c5ce7; border-color: #6c5ce7;' : 'background: #2b2b36;'"
                          style="display: block; text-align: center; padding: 12px; border-radius: 8px; border: 1px solid #444; transition: 0.2s;">
                        üìê Math
                    </span>
                </label>
            </div>

            <button @click="openTopicSelection" style="background: linear-gradient(135deg, #00b894, #00cec9); margin-bottom: 10px;">
                üéì –¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ —Å –ò–ò
            </button>
            <button @click="startSearch" style="background: linear-gradient(135deg, #6c5ce7, #a29bfe); margin-bottom: 10px;">
                ‚öîÔ∏è PvP –ë–∏—Ç–≤–∞
            </button>
             <button class="btn-secondary" @click="openCatalog">
                üìÇ –ö–∞—Ç–∞–ª–æ–≥ –∑–∞–¥–∞—á
            </button>
        </div>
    </div>

    <!-- ========================================== -->
    <!-- 3. –ö–ê–¢–ê–õ–û–ì                                 -->
    <!-- ========================================== -->
    <div v-else-if="state === 'catalog'">
        <div class="header-bar">
            <h3>–ö–∞—Ç–∞–ª–æ–≥: {{ subject.toUpperCase() }}</h3>
            <button class="btn-secondary btn-small" @click="state='menu'">–ù–∞–∑–∞–¥</button>
        </div>

        <div v-if="trainingTasks.length === 0" style="text-align: center; padding: 20px; color: #666;">
            –ö–∞—Ç–∞–ª–æ–≥ –ø—É—Å—Ç. –°–≥–µ–Ω–µ—Ä–∏—Ä—É–π—Ç–µ –∑–∞–¥–∞—á–∏ –≤ –¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–µ!
        </div>

        <div v-for="t in trainingTasks" :key="t.id" @click="openTaskManual(t)"
             style="background: #2d2d35; padding: 15px; margin-bottom: 10px; border-radius: 10px; cursor: pointer; display: flex; justify-content: space-between; align-items: center;">
            <div>
                <div style="font-weight: bold; display: flex; align-items: center; gap: 10px;">
                    {{ t.title }} <span v-if="t.is_solved" style="color: #00b894;">‚úÖ</span>
                </div>
                <div style="font-size: 12px; color: #888; margin-top: 5px;">
                    {{ t.topic }} ‚Ä¢
                    <span style="color: #fdcb6e;"><i class="fas fa-star" v-for="n in t.difficulty"></i></span>
                </div>
            </div>
            <div style="color: #666;">‚ûú</div>
        </div>
    </div>

    <!-- ========================================== -->
    <!-- 4. –í–´–ë–û–† –¢–ï–ú–´ (AI)                         -->
    <!-- ========================================== -->
    <div v-else-if="state === 'topic_select'">
        <div class="header-bar">
            <h3>–¢–µ–º—ã: {{ subject }}</h3>
            <button class="btn-secondary btn-small" @click="state='menu'">–ù–∞–∑–∞–¥</button>
        </div>

        <!-- –°–ª–∞–π–¥–µ—Ä —Å–ª–æ–∂–Ω–æ—Å—Ç–∏ -->
        <div class="card" style="margin-bottom: 20px;">
            <label style="font-weight: bold; display: block; margin-bottom: 10px;">
                –ñ–µ–ª–∞–µ–º–∞—è —Å–ª–æ–∂–Ω–æ—Å—Ç—å: {{ selectedDifficulty }}/5
            </label>
            <input type="range" min="1" max="5" v-model.number="selectedDifficulty" style="width: 100%;">
            <div style="display: flex; justify-content: space-between; font-size: 10px; color: #888;">
                <span>–õ–µ–≥–∫–æ</span><span>–ù–æ—Ä–º–∞–ª—å–Ω–æ</span><span>–•–∞—Ä–¥–∫–æ—Ä</span>
            </div>
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
            <div v-for="topic in currentTopics" :key="topic.id"
                 @click="selectTopic(topic.id)"
                 style="background: #2d2d35; padding: 20px; border-radius: 12px; text-align: center; cursor: pointer; border: 1px solid #444;">
                <div style="font-size: 32px; margin-bottom: 8px;">{{ topic.icon }}</div>
                <div style="font-weight: 600; font-size: 14px;">{{ topic.name }}</div>
            </div>
        </div>
        <div v-if="!currentTopics.length" style="text-align: center; margin-top: 20px; color: #666;">
            –ù–µ—Ç —Ç–µ–º –¥–ª—è –≤–∞—à–µ–≥–æ –∫–ª–∞—Å—Å–∞.
        </div>
    </div>

    <!-- ========================================== -->
    <!-- 5. –ó–ê–ì–†–£–ó–ö–ê –ò–ò                             -->
    <!-- ========================================== -->
    <div v-else-if="state === 'loading_ai'" style="text-align: center; padding-top: 50px;">
        <div class="brain-anim" style="font-size: 80px; margin-bottom: 20px;">üß†</div>
        <h2>–ò–ò –¥—É–º–∞–µ—Ç...</h2>
        <p style="color: #888;">–ü–æ–¥–±–∏—Ä–∞–µ–º –∑–∞–¥–∞—á—É –¥–ª—è {{ userStats.grade }} –∫–ª–∞—Å—Å–∞</p>
    </div>

    <!-- ========================================== -->
    <!-- 6. –†–ï–®–ï–ù–ò–ï –ó–ê–î–ê–ß–ò (–≠–¢–û–¢ –ë–õ–û–ö –ë–´–õ –°–õ–û–ú–ê–ù)   -->
    <!-- ========================================== -->
    <div v-else-if="state === 'training_solve'">
        <div class="header-bar">
            <span style="background: #fdcb6e; color: #222; padding: 4px 8px; border-radius: 4px; font-weight: bold;">
                –°–ª–æ–∂–Ω–æ—Å—Ç—å: {{ activeTask.difficulty }}‚≠ê
            </span>
            <button class="btn-secondary btn-small" @click="state === 'catalog' ? state='catalog' : openTopicSelection()">–ù–∞–∑–∞–¥</button>
        </div>

        <div class="card">
            <h2 style="margin-top: 0;">{{ activeTask.title }}</h2>
            <p style="color: #b2bec3; line-height: 1.6; white-space: pre-wrap;">{{ activeTask.description }}</p>
        </div>

        <!-- –í–ê–†–ò–ê–ù–¢–´ –û–¢–í–ï–¢–ê (–ï–°–õ–ò TYPE CHOICE) -->
        <div v-if="activeTask.task_type === 'choice'" style="display: grid; gap: 10px;">
            <button v-for="opt in activeTask.options"
                    :key="opt"
                    @click="submitTrainingAnswer(opt)"
                    :disabled="solveResult === 'correct'"
                    style="background: #2d2d35; border: 1px solid #555; text-align: left; padding: 15px;">
                {{ opt }}
            </button>
        </div>

        <!-- –í–í–û–î –û–¢–í–ï–¢–ê (–ï–°–õ–ò TYPE TEXT) -->
        <div v-else>
            <input v-model="trainingAnswer" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à –∫–æ–¥ –∏–ª–∏ –æ—Ç–≤–µ—Ç..." @keyup.enter="submitTrainingAnswer()">
            <button @click="submitTrainingAnswer()">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å</button>
        </div>

        <!-- –†–ï–ó–£–õ–¨–¢–ê–¢ -->
        <div v-if="solveResult"
             style="margin-top: 20px; padding: 15px; border-radius: 8px; font-weight: bold; text-align: center;"
             :class="solveResult === 'correct' ? 'win-text' : 'lose-text'"
             :style="solveResult === 'correct' ? 'background: rgba(0, 184, 148, 0.1);' : 'background: rgba(255, 118, 117, 0.1);'">
            {{ solveResult === 'correct' ? '‚úÖ –í–µ—Ä–Ω–æ! +XP' : '‚ùå –ù–µ–≤–µ—Ä–Ω–æ' }}
        </div>

        <!-- –ü–û–î–°–ö–ê–ó–ö–ò -->
        <div class="hints-section" v-if="activeTask.hints_available > 0">
            <hr style="border: 0; border-top: 1px solid #333; margin: 20px 0;">

            <div v-for="(hint, idx) in revealedHints" :key="idx"
                 style="background: rgba(253, 203, 110, 0.1); border: 1px solid #fdcb6e; color: #fdcb6e; padding: 10px; border-radius: 8px; margin-bottom: 10px;">
                üí° <span v-html="hint"></span>
            </div>

            <button v-if="revealedHints.length < activeTask.hints_available"
                    @click="useHint"
                    class="btn-secondary"
                    style="width: 100%; border-style: dashed; color: #888;"
                    :disabled="isHintLoading || solveResult === 'correct'">
                {{ isHintLoading ? '–ó–∞–≥—Ä—É–∑–∫–∞...' : `üîç –í–∑—è—Ç—å –ø–æ–¥—Å–∫–∞–∑–∫—É (${revealedHints.length}/${activeTask.hints_available})` }}
            </button>
        </div>
    </div>

    <!-- ========================================== -->
    <!-- 7. –ü–û–ò–°–ö PVP                               -->
    <!-- ========================================== -->
    <div v-else-if="state === 'searching'" style="text-align: center; margin-top: 80px;">
        <div class="searching-anim" style="font-size: 60px;">üì°</div>
        <h2>–ü–æ–∏—Å–∫ —Å–æ–ø–µ—Ä–Ω–∏–∫–∞...</h2>
        <p style="color: #888;">{{ subject.toUpperCase() }} ({{ userStats.grade }}¬±1 –∫–ª–∞—Å—Å)</p>
        <button class="btn-secondary" style="width: 200px;" @click="reset">–û—Ç–º–µ–Ω–∞</button>
    </div>

    <!-- ========================================== -->
    <!-- 8. VS EKRAN                                -->
    <!-- ========================================== -->
    <div v-else-if="state === 'vs'" class="vs-container">
        <div class="vs-card">
            <div class="vs-avatar">üë§</div>
            <div class="vs-name">{{ userStats.username }}</div>
            <div class="vs-rating">{{ userStats.rating }}</div>
        </div>
        <div class="vs-center">
            <div class="vs-logo">VS</div>
            <div class="vs-timer">{{ vsTimer }}</div>
        </div>
        <div class="vs-card">
            <div class="vs-avatar">üë§</div>
            <div class="vs-name">{{ opponentName }}</div>
            <div class="vs-rating">{{ opponentRating }}</div>
        </div>
    </div>

    <!-- ========================================== -->
    <!-- 9. PVP –ò–ì–†–ê                                -->
    <!-- ========================================== -->
    <div v-else-if="state === 'playing'">
        <div class="header-bar">
            <div class="score-box" :style="{borderColor: myScore > enemyScore ? '#00b894' : '#444'}">–í—ã: {{ myScore }}</div>
            <div style="color: #888; font-size: 12px;">–†–ê–£–ù–î {{ currentRound }}/{{ totalRounds }}</div>
            <div class="score-box" :style="{borderColor: enemyScore > myScore ? '#d63031' : '#444'}">–í—Ä–∞–≥: {{ enemyScore }}</div>
        </div>

        <div class="timer-big" :style="{color: timeLeft !== '‚àû' && timeLeft < 15 ? '#ff7675' : '#fdcb6e'}">
            {{ timeLeft }}
        </div>

        <div class="card">
            <div style="display: flex; justify-content: space-between;">
                <h3 style="margin: 0;">{{ task.title }}</h3>
                <span style="color: #fdcb6e;"><i class="fas fa-star" v-for="n in task.difficulty"></i></span>
            </div>
            <p style="color: #b2bec3;">{{ task.desc }}</p>
        </div>

        <div v-if="!roundFinished">
            <div v-if="task.task_type === 'choice' && task.options" style="display: grid; gap: 10px;">
                <button v-for="opt in task.options" :key="opt" @click="answer=opt; sendPvPAnswer()"
                        class="choice-btn" :disabled="answerSent"
                        style="background: #2d2d35; border: 1px solid #555; text-align: left; padding: 15px;">
                    {{ opt }}
                </button>
            </div>
            <div v-else>
                <input id="pvpInput" v-model="answer" placeholder="–û—Ç–≤–µ—Ç..." @keyup.enter="sendPvPAnswer" :disabled="answerSent">
                <button @click="sendPvPAnswer" :disabled="answerSent" :style="{background: answerSent ? '#2d3436' : ''}">
                    {{ answerSent ? '‚è≥ –ñ–¥–µ–º...' : '–û–¢–í–ï–¢–ò–¢–¨' }}
                </button>
            </div>
        </div>

        <div v-else class="card" style="text-align: center;">
            <h2 :class="roundResult.you === 'correct' ? 'win-text' : 'lose-text'">
                {{ roundResult.you === 'correct' ? '‚úÖ –í–µ—Ä–Ω–æ!' : '‚ùå –û—à–∏–±–∫–∞' }}
            </h2>
            <div style="margin-top: 5px; color: #888;">–ü—Ä–∞–≤–∏–ª—å–Ω–æ: {{ roundResult.correct }}</div>
            <div class="next-round-bar" style="margin-top: 15px; height: 4px; background: #333;">
                <div class="next-round-progress" :style="{width: (nextRoundTimer / 4 * 100) + '%', background: '#6c5ce7', height: '100%'}"></div>
            </div>
        </div>
    </div>

    <!-- ========================================== -->
    <!-- 10. –§–ò–ù–ê–õ                                  -->
    <!-- ========================================== -->
    <div v-else-if="state === 'finished'" style="text-align: center; padding-top: 50px;">
        <h1 :class="finalData.result === 'win' ? 'win-text' : (finalData.result === 'lose' ? 'lose-text' : 'draw-text')">
            {{ finalData.result === 'win' ? 'üèÜ –ü–û–ë–ï–î–ê!' : (finalData.result === 'lose' ? 'üíÄ –ü–û–†–ê–ñ–ï–ù–ò–ï' : 'ü§ù –ù–ò–ß–¨–Ø') }}
        </h1>
        <h2 style="font-size: 48px; margin: 20px 0;">{{ myScore }} : {{ enemyScore }}</h2>
        <p v-if="finalData.new_rating" style="color: #fdcb6e;">–ù–æ–≤—ã–π —Ä–µ–π—Ç–∏–Ω–≥: {{ finalData.new_rating }}</p>
        <button @click="reset">–í –ú–ï–ù–Æ</button>
    </div>

    <!-- –ú–û–î–ê–õ–ö–ò -->
<!-- 10. –ú–û–î–ê–õ–ö–ê –ò–°–¢–û–†–ò–ò -->
    <div v-if="modal.history" class="modal-overlay">
        <div style="max-width: 500px; margin: 0 auto;">
            <div class="header-bar">
                <h2>–ò—Å—Ç–æ—Ä–∏—è</h2>
                <button class="btn-secondary btn-small" @click="modal.history = false">X</button>
            </div>

            <div v-for="m in history" :key="m.id" class="task-list-item"
                 :style="{borderLeft: '4px solid ' + (getMyResult(m)==='win'?'#00b894':(getMyResult(m)==='lose'?'#ff7675':'#fdcb6e'))}">
                <div>
                    <b>{{ m.subject }}</b><br>
                    <small>{{ new Date(m.played_at).toLocaleDateString() }}</small>
                </div>
                <div style="text-align:right">
                    <b>{{ getScoreText(m) }}</b><br>
                    <small>{{ getResultText(m) }}</small>
                </div>
            </div>
        </div>
    </div>

    <!-- 11. –ú–û–î–ê–õ–ö–ê –ê–ù–ê–õ–ò–¢–ò–ö–ò -->
    <div v-if="modal.analytics" class="modal-overlay">
        <div class="modal-content">
            <div class="header-bar">
                <h2>üìä –ê–Ω–∞–ª–∏—Ç–∏–∫–∞</h2>
                <button class="btn-secondary btn-small" @click="modal.analytics = false">X</button>
            </div>

            <div v-if="analyticsData" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                <div class="card" style="text-align:center;margin:0;">
                    <div style="font-size:36px;color:#00b894;">{{ analyticsData.win_rate }}%</div>
                    <small>Win Rate</small>
                </div>
                <div class="card" style="text-align:center;margin:0;">
                    <div style="font-size:36px;color:#6c5ce7;">{{ analyticsData.total_solved_training }}</div>
                    <small>–ó–∞–¥–∞—á</small>
                </div>
                <div class="card" style="grid-column: span 2; margin:0;">
                    <h4>–ü–æ –ø—Ä–µ–¥–º–µ—Ç–∞–º</h4>
                    <div v-for="(s, k) in analyticsData.subject_stats" :key="k" style="margin-bottom:10px;">
                        <div style="display:flex;justify-content:space-between;">
                            <span>{{ k }}</span>
                            <span>{{ Math.round(s.wins/s.total*100) }}%</span>
                        </div>
                        <div style="height:6px;background:#333;border-radius:3px;">
                            <div :style="{width: (s.wins/s.total*100)+'%', background:'#0984e3', height:'100%'}"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

</div>
<script type="module" src="/static/js/app.js?v=FIX_TRAINING_FINAL"></script>
</body>
</html>