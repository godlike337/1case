<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Olimpics</title>

    <!-- Шрифты и иконки -->
    <link rel="stylesheet" href="/static/css/webfonts/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Rajdhani:wght@500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/static/css/style.css">

    <link rel="icon" href="static/favicon.ico">

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!--Katex-->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>
</head>
<body>

<!-- Эффекты фона -->
<div class="scanlines"></div>
<div class="noise"></div>

<div id="app" v-cloak :class="['app-container', state]">

    <!-- ================= АВТОРИЗАЦИЯ ================= -->
    <div v-if="['login', 'register', 'forgot'].includes(state)" class="screen-auth">
        <div class="auth-card">
            <h1 class="auth-title">OLIMP<span class="accent">ICS</span></h1>

            <!-- Вход -->
            <form v-if="state === 'login'" @submit.prevent="login">
                <div class="input-group">
                    <i class="fa-solid fa-user"></i>
                    <input type="text" v-model="authForm.username" placeholder="Логин" required>
                </div>
                <div class="input-group">
                    <i class="fa-solid fa-lock"></i>
                    <input type="password" v-model="authForm.password" placeholder="Пароль" required>
                </div>
                <button type="submit" class="cyber-btn full">Войти</button>
                <div class="auth-links">
                    <a href="#" @click.prevent="goTo('register')">[ Регистрация ]</a>
                    <a href="#" @click.prevent="goTo('forgot')">[ Забыли пароль? ]</a>
                </div>
            </form>

            <!-- Регистрация -->
            <form v-if="state === 'register'" @submit.prevent="register">
                <div class="input-group">
                    <i class="fa-solid fa-user"></i>
                    <input type="text" v-model="authForm.username" placeholder="Логин" required>
                </div>
                <div class="input-group">
                    <i class="fa-solid fa-envelope"></i>
                    <input type="email" v-model="authForm.email" placeholder="Почта" required>
                </div>
                <div class="input-group">
                    <i class="fa-solid fa-graduation-cap"></i>
                    <select v-model.number="authForm.grade" required>
                        <option disabled value="">Класс</option>
                        <option v-for="g in 11" :key="g" :value="g">Класс: {{ g }}</option>
                    </select>
                </div>
                <div class="input-group">
                    <i class="fa-solid fa-lock"></i>
                    <input type="password" v-model="authForm.password" placeholder="Пароль" required>
                </div>
                <button type="submit" class="cyber-btn full">Создать аккаунт</button>
                <div class="auth-links">
                    <a href="#" @click.prevent="goTo('login')">&lt; Назад</a>
                </div>
            </form>

            <!-- Сброс пароля -->
            <div v-if="state === 'forgot'" class="forgot-block">
                <p>Для сброса пароля обратитесь в поддержку:</p>
                <a href="https://t.me/whosgodlike" target="_blank" class="cyber-btn tg-btn">
                    <i class="fa-brands fa-telegram"></i> Написать в Поддержку
                </a>
                <div class="auth-links">
                    <a href="#" @click.prevent="goTo('login')">&lt; Назад</a>
                </div>
            </div>
        </div>
    </div>

    <!-- ================= ОСНОВНОЙ ИНТЕРФЕЙС ================= -->
    <div v-else class="main-layout">

        <!-- Верхняя шапка -->
        <header class="top-bar">
            <div class="user-info">
                <span class="username">{{ userStats.username }}</span>
                <span class="badge level">Lvl {{ userStats.level }}</span>
                <span class="badge rating"> {{ userStats.rating }} elo</span>
            </div>
            <button class="cyber-btn sm" @click="goTo('profile')">
                <i class="fa-solid fa-id-card"></i> <span class="desktop-only">ПРОФИЛЬ</span>
            </button>
        </header>

        <!-- Контент -->
        <main class="content-area">

            <!-- МЕНЮ -->
            <div v-if="state === 'menu'" class="screen-menu">
                <h2 class="auth-title glitch" data-text="OLIMPICS" style="font-size:4rem">OLIMP<span class="accent">ICS</span></h2>
                <div class="menu-buttons">
                    <button class="cyber-btn lg" @click="goTo('topic_select')">
                       Тренировка
                    </button>
                    <button class="cyber-btn lg red-glow" @click="goTo('pvp_setup')">
                       PVP
                    </button>
                </div>
            </div>

            <!-- ПРОФИЛЬ -->
            <div v-if="state === 'profile'" class="screen-profile">
                <div class="profile-header">
                    <button class="back-btn" @click="goTo('menu')"><i class="fa-solid fa-chevron-left"></i> Назад</button>
                    <h2 class="section-title">Профиль</h2>
                </div>

                <div class="profile-grid">
                    <!-- Левая колонка -->
                    <div class="profile-card stats-card cyber-border">
                        <div class="avatar-ph">
                            <i class="fa-solid fa-user-astronaut"></i>
                        </div>
                        <h3>{{ userStats.username }}</h3>
                        <div class="xp-container">
                            <div class="xp-info">
                                <span>Lvl {{ userStats.level }}</span>
                                <span>{{ userStats.xp }} XP</span>
                            </div>
                            <div class="xp-bar-bg"><div class="xp-bar-fill" :style="{width: (userStats.xp % 100) + '%'}"></div></div>
                        </div>
                        <div class="mini-stats">
                            <div class="stat-row"><span>Побед:</span><strong>{{ userStats.wins }}</strong></div>
                            <div class="stat-row"><span>Матчей:</span><strong>{{ analyticsData?.total_matches }}</strong></div>
                        </div>
                        <div class="achievements-box" v-if="userStats.achievements && userStats.achievements.length > 0">
                            <h4>ДОСТИЖЕНИЯ</h4>
                            <div class="ach-grid">
                                <div v-for="ach in userStats.achievements" :key="ach.name" class="ach-item" :title="ach.description">
                                    <span class="ach-icon">{{ ach.icon }}</span>
                                    <span class="ach-name">{{ ach.name }}</span>
                                </div>
                            </div>
                        </div>
                        <div v-else class="achievements-box">
                            <p style="color:#556; font-size:0.8rem">НЕТ ДОСТИЖЕНИЙ</p>
                        </div>
                        <button class="cyber-btn sm logout" @click="logout">Выйти</button>
                    </div>

                    <!-- Правая колонка -->
                    <div class="profile-content cyber-border">
                        <div class="tabs">
                            <button :class="['tab-btn', {active: profileTab==='analytics'}]" @click="profileTab='analytics'">Аналитика</button>
                            <button :class="['tab-btn', {active: profileTab==='history'}]" @click="profileTab='history'">История</button>
                        </div>

                        <div v-show="profileTab==='analytics'" class="analytics-view">
                            <div class="charts-row">
                                <div class="chart-box">
                                    <canvas id="winRateChart"></canvas>
                                </div>
                                <div class="stats-text-box">
                                    <p>Винрейт: <span class="accent">{{ analyticsData?.win_rate?.toFixed(1)  }}%</span></p>
                                    <p>Точность: <span class="accent">{{ analyticsData?.correct_answers?.toFixed(1)  }}%</span></p>
                                    <p>Ср. время: <span class="accent">{{ analyticsData?.avg_solving_time  }}с</span></p>
                                </div>
                            </div>
                            <div class="chart-box full-width">
                                <h4>Усвоение тем</h4>
                                <canvas id="topicsChart"></canvas>
                            </div>
                        </div>

                        <div v-show="profileTab==='history'" class="history-view">
                            <div class="history-list">
                                <div v-for="match in paginatedHistory" :key="match.id" class="match-item">
                                    <div class="match-date">{{ formatDate(match.played_at) }}</div>
                                    <div class="match-vs">
                                        <span >{{ match.player1 ? match.player1.username : '???' }}</span>
                                        <span class="vs-badge"> VS </span>
                                        <span >{{ match.player2 ? match.player2.username : '???' }}</span>
                                    </div>
                                    <div class="match-score">{{ match.p1_score }} : {{ match.p2_score }}</div>
                                    <div :class="['match-result', getMyResult(match)]">{{ getResultText(match) }}</div>
                                </div>
                                <div v-if="history.length === 0" class="no-data">История матчей пуста</div>
                            </div>
                            <div class="pagination">
                                <button class="cyber-btn sm" @click="historyPage--" :disabled="historyPage === 0">&lt;</button>
                                <span>Стр {{ historyPage + 1 }}</span>
                                <button class="cyber-btn sm" @click="historyPage++" :disabled="(historyPage + 1) * 5 >= history.length">&gt;</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ТРЕНИРОВКА: Выбор темы -->
            <div v-if="state === 'topic_select'" class="screen-setup">
                <button class="back-btn" @click="goTo('menu')"><i class="fa-solid fa-arrow-left"></i> Назад</button>
                <h2 class="section-title">Настройки</h2>

                <div class="setup-group cyber-border">
                    <label>Предмет:</label>
                    <div class="subject-toggles">
                        <button class="cyber-btn" :class="{active: subject==='python'}" @click="subject='python'">PYTHON</button>
                        <button class="cyber-btn" :class="{active: subject==='math'}" @click="subject='math'">МАТЕМАТИКА</button>
                    </div>
                </div>

                <div class="setup-group cyber-border">
                    <label>Сложность: <span class="accent">{{ selectedDifficulty }}/5</span></label>
                    <input type="range" min="1" max="5" v-model.number="selectedDifficulty" class="cyber-range">
                </div>

                <div class="topics-grid">
                    <button v-for="t in currentTopics" :key="t.id" class="topic-card" @click="selectTopic(t.id)">
                        {{ t.name }}
                    </button>
                </div>
            </div>

            <!-- PVP: Настройка (ВЫБОР ПРЕДМЕТА) -->
            <div v-if="state === 'pvp_setup'" class="screen-setup">
                <button class="back-btn" @click="goTo('menu')"><i class="fa-solid fa-arrow-left"></i> Назад</button>
                <h2 class="section-title glitch" data-text="ПОИСК ИГРЫ">Поиск Игры</h2>

                <div class="setup-group cyber-border">
                    <label>ВЫБЕРИТЕ ПРЕДМЕТ:</label>
                    <div class="subject-toggles">
                        <button class="cyber-btn red-glow" :class="{active: subject==='python'}" @click="subject='python'">PYTHON</button>
                        <button class="cyber-btn red-glow" :class="{active: subject==='math'}" @click="subject='math'">МАТЕМАТИКА</button>
                    </div>
                </div>

                <div style="text-align: center; margin-top: 50px;">
                    <button class="cyber-btn lg red-glow" @click="startPvP">
                        <i class="fa-solid fa-satellite-dish"></i> НАЧАТЬ ПОИСК
                    </button>
                </div>
            </div>

            <!-- ТРЕНИРОВКА / PVP: Решение задачи -->
            <div v-if="state === 'training_solve' || state === 'playing'" class="screen-game">
                <div class="game-header">
                    <button v-if="state === 'training_solve'" class="back-btn" @click="goTo('topic_select')">Выход</button>
                    <div v-if="state === 'playing'" class="pvp-score-board cyber-border">
                        <div class="p-score me">Я: {{ myScore }}</div>
                        <div class="timer" :class="{danger: timeLeft < 10}">{{ timeLeft }}</div>
                        <div class="p-score enemy">ОПП: {{ enemyScore }}</div>
                    </div>
                </div>

                <div class="task-card cyber-border">
                    <div class="task-meta">
                        <span class="task-diff">Сложность: {{ activeTask?.difficulty || task?.difficulty }}</span>
                        <span class="task-type">{{ (activeTask?.task_type || task?.task_type) === 'choice' ? 'ТЕСТ' : 'ВВОД' }}</span>
                    </div>
                    <h3 class="task-title">{{ activeTask?.title || task?.title }}</h3>
                    <div class="task-desc" v-html="(activeTask?.description || task?.description)"></div>

                    <!-- Варианты ответа -->
                    <div v-if="(activeTask?.task_type || task?.task_type) === 'choice'" class="options-grid">
                        <button v-for="opt in (activeTask?.options || task?.options)"
                                :key="opt"
                                class="option-btn"
                                @click="handleAnswer(opt)">
                            {{ opt }}
                        </button>
                    </div>

                    <!-- Текстовый ввод -->
                    <div v-else class="text-answer-box">
                        <input type="text"
                               v-model="currentAnswerInput"
                               placeholder="Введите ответ..."
                               @keyup.enter="handleAnswer(currentAnswerInput)"
                               :disabled="solveResult !== null || answerSent">
                        <button class="cyber-btn" @click="handleAnswer(currentAnswerInput)">ОТПРАВИТЬ</button>
                    </div>

                    <!-- Результат (Тренировка) -->
                    <div v-if="solveResult" :class="['result-msg', solveResult]">
                        {{ solveResult === 'correct' ? 'ВЕРНО' : 'НЕВЕРНО' }}
                        <button v-if="solveResult === 'correct'" @click="goTo('topic_select')" class="cyber-btn sm">ДАЛЕЕ &gt;</button>
                    </div>

                    <!-- Результат раунда (PVP) -->
                    <div v-if="roundFinished" class="round-overlay">
                        <div class="round-modal cyber-border">
                            <h3>РАУНД ЗАВЕРШЕН</h3>
                            <div class="round-res-grid">
                                <div :class="roundResult.you">ВЫ</div>
                                <div :class="roundResult.enemy">СОПЕРНИК</div>
                            </div>
                            <p class="correct-text">ОТВЕТ: {{ roundResult.correct }}</p>
                            <div class="loading-bar">
                                <div class="bar-fill" :style="{width: (nextRoundTimer/4)*100 + '%'}"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Подсказки (только тренировка) -->
                    <div v-if="state === 'training_solve'" class="hints-section">
                        <div v-for="(h, idx) in revealedHints" :key="idx" class="hint-bubble">{{ h }}</div>
                        <button v-if="revealedHints.length < (activeTask?.hints_available || 0)"
                                @click="useHint"
                                class="cyber-btn sm hint-btn">
                            <i class="fa-regular fa-lightbulb"></i> ПОДСКАЗКА
                        </button>
                    </div>
                </div>
            </div>

            <!-- PVP: Поиск -->
            <div v-if="state === 'searching'" class="screen-centered">
                <div class="loader-ring"></div>
                <h2 class="glitch" data-text="ПОИСК...">ПОИСК...</h2>
                <button class="cyber-btn red-glow" @click="reset">ОТМЕНА</button>
            </div>

             <!-- PVP: VS Экран -->
             <div v-if="state === 'vs'" class="screen-vs">
                <div class="vs-player me">
                    <div class="av">Я</div>
                    <h3>{{ userStats.username }}</h3>
                    <p>{{ userStats.rating }} ELO</p>
                </div>
                <div class="vs-center">
                    <h1 class="glitch" data-text="VS">VS</h1>
                    <div class="countdown">{{ vsTimer }}</div>
                </div>
                <div class="vs-player enemy">
                    <div class="av">ОПП</div>
                    <h3>{{ opponentName }}</h3>
                    <p>{{ opponentRating }} ELO</p>
                </div>
            </div>

            <!-- PVP: Финал -->
            <div v-if="state === 'finished'" class="screen-centered">
                <h1 :class="['final-title', finalData.result === 'win' ? 'text-win' : 'text-lose']">
                    {{ finalData.result === 'win' ? 'ПОБЕДА' : finalData.result === 'draw' ? 'НИЧЬЯ' : 'ПОРАЖЕНИЕ' }}
                </h1>
                <div class="final-score cyber-border">
                    {{ finalData.my_score }} - {{ finalData.enemy_score }}
                </div>
                <p>Новый рейтинг: <span class="accent">{{ finalData.new_rating }}</span></p>
                <button class="cyber-btn lg" @click="goTo('menu')">В МЕНЮ</button>
            </div>

            <!-- Загрузка AI -->
            <div v-if="state === 'loading_ai'" class="screen-centered">
                <div class="ai-loader">
                    <span></span><span></span><span></span>
                </div>
                <h3>ИИ СОЗДАЕТ ЗАДАЧУ...</h3>
            </div>

        </main>

        <!-- Нижняя шапка -->
        <footer class="bottom-bar">
            <a href="https://t.me/whosgodlike" target="_blank" class="support-link">
                <i class="fa-regular fa-life-ring"></i> Поддержка
            </a>
            <span class="copyright">OlimpicOS System</span>
        </footer>
    </div>
</div>

<script type="module" src="/static/js/app.js"></script>
</body>
</html>